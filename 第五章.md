# 第五章 堆溢出利用

## 5.1 工作原理

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-1-1.png)

### 5.1.1 空闲双向链表Freelist

1. 利用表头组织成双向链表，共128条
2. 一开始有128项空表索引（Freelist Array），每项两个指针
3. 空闲堆块的大小=索引项*8字节

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-1-2.png)

### 5.1.2 快速单向链表Lookaside

1. 快表即永远不会发生堆块合并（其空闲块块首被设置为占用态）
2. 128条，按照单链表组织，每条块表最多只有4个节点

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-1-3.png)

### 5.1.3 堆块的操作

#### 5.1.3.1 分配

1. 分为：快表分配、普通空表分配和零表分配（free[0]）
2. 快表分配：寻找到大小匹配（精确匹配）的空闲堆块、将其状态改为占用态、从堆表中卸下、最后返回一个指向堆块的指针
3. 普通空表分配：寻找最优的空闲块分配，若无，找次优解
4. 零表分配：先逆序查看最大的快，看是否能满足要求，若能，再从正向搜索能满足要求的最小堆块

#### 5.1.3.2 释放

堆块状态改为空闲、炼入相应的堆表

#### 5.1.3.3 合并

将两个块从空闲链表中卸下、合并堆块、调整合并后的块首信息、将新块重新链入空闲链表

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-1-4.png)

### 5.1.4 注意事项

1. 快表不会发生合并
2. 快表只有精确匹配才会分配，不存在“次优解”和“找零钱”
3. 快表是单链表，最多只有四项，很容易被填满

## 5.2 在堆中漫游

### 5.2.1 函数

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-2-1.png)

1. 调试态堆管理策略的差异：

   （1）不使用快表，只用空表

   （2）所有堆块都被加上了多余的16字节尾部来防止溢出（8个0xAB和8个0x00）

   （3）块首的标志位不同

### 5.2.3 识别堆表

1. 初始化的堆区内容：段表索引（segment list）、虚表索引（virtul allocation list）、空表使用索引（freelist usage bitmap）和空表索引区（位于0x178）
2. 初始化的堆，只有一个大块，被称为尾块
3. free[0]指向尾块
4. 其余的free[1]等指向自身，即其余空表都无空闲块

### 5.2.4 堆块的分配

1. 堆块大小包括了块首8个字节，例如请求32字节，分配40字节
2. 堆块的单位为8字节，不足8字节，按照8字节补全
3. 初始状态，空表、快表都为空，按照次优解进行分配，也就是利用尾块进行分配

### 5.2.7 快表的使用

1. 尾块的位置被快表霸占
2. 问题：如下图，为什么分配8字节，下一个堆块地址占用了4字节，也就是只剩4字节？

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-2-2.png)

## 5.3 堆溢出利用（上）——DWORD SHOOT

### 5.3.1 定义

向内存任意位置写入任意数据的机会称为“DWORD SHOOT”

|   Target   |    Payload    |       Result        |
| :--------: | :-----------: | :-----------------: |
|  栈帧中返回地址   | shellcode起始地址 | 函数返回时，跳去执行shellcode |
| 栈帧中S.E.H句柄 | shellcode起始地址 | 异常发生时，跳去执行shellcode |
|  重要函数调用地址  | shellcode起始地址 | 函数调用时，跳去执行shellcode |

堆溢出->淹没下一个块首的后向指针（flink）和前向指针（blink）->当卸下时，用flink改写blink地址的值

![](https://github.com/dvstter/0DayLearningNotes/blob/master/resources/5-3-1.png)